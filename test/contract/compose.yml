services:
  contract-tests:
    # NOTE: v4.7.7 is the latest version to avoid issues with checking for request
    # payload bodies with the forbidden "__proto__" property name!!
    image: schemathesis/schemathesis:4.7.7
    entrypoint: sh
    command:
      - -c
      - |
        result=0
        for schema in person organisation authenticate siti-agri ; do
          echo "Running contract tests for schema: $${schema}"
          schemathesis run --exclude-checks=unsupported_method,not_a_server_error \
            --report-vcr-path /tmp/$${schema}.logs.yaml \
            "http://dal-mock:3100/schemata/$${schema}.yml" \
            && rm /tmp/$${schema}.logs.yaml
          result=$((result | $?))
        done
        if [ $${result} -eq 0 ] ; then
          echo -e "\n✅ All contract tests passed successfully."
        else
          echo -e "\n❌ One or more contract tests failed!"
        fi
        exit $$result
    depends_on:
      dal-mock:
        condition: service_healthy
    networks:
      - default
    volumes:
      - ./test/contract/logs:/tmp
